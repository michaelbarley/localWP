#!/bin/bash

set -e

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Default values
DEFAULT_PORT=8080
DEFAULT_DB_PORT=3306
SITES_DIR="$HOME/localwp-sites"

print_header() {
    echo -e "${BLUE}"
    echo "╔═══════════════════════════════════════╗"
    echo "║           LocalWP - Docker            ║"
    echo "║   WordPress Development Made Easy     ║"
    echo "╚═══════════════════════════════════════╝"
    echo -e "${NC}"
}

create_site() {
    # Prompt for site name
    echo -e "${GREEN}Site name${NC} (lowercase, no spaces):"
    read -r SITE_NAME

    if [[ -z "$SITE_NAME" ]]; then
        echo "Site name is required."
        exit 1
    fi

    # Sanitize site name
    SITE_NAME=$(echo "$SITE_NAME" | tr '[:upper:]' '[:lower:]' | tr ' ' '-' | tr -cd '[:alnum:]-')

    SITE_DIR="$SITES_DIR/$SITE_NAME"

    if [[ -d "$SITE_DIR" ]]; then
        echo "Site '$SITE_NAME' already exists at $SITE_DIR"
        exit 1
    fi

    # Prompt for port
    echo -e "${GREEN}WordPress port${NC} [${DEFAULT_PORT}]:"
    read -r WP_PORT
    WP_PORT=${WP_PORT:-$DEFAULT_PORT}

    # Prompt for phpMyAdmin
    echo -e "${GREEN}Include phpMyAdmin?${NC} [Y/n]:"
    read -r INCLUDE_PMA
    INCLUDE_PMA=${INCLUDE_PMA:-Y}

    if [[ "$INCLUDE_PMA" =~ ^[Yy]$ ]]; then
        echo -e "${GREEN}phpMyAdmin port${NC} [8081]:"
        read -r PMA_PORT
        PMA_PORT=${PMA_PORT:-8081}
    fi

    # WordPress setup details
    echo ""
    echo -e "${BLUE}WordPress Setup${NC}"

    echo -e "${GREEN}Site title${NC} [${SITE_NAME}]:"
    read -r WP_TITLE
    WP_TITLE=${WP_TITLE:-$SITE_NAME}

    echo -e "${GREEN}Admin username${NC} [admin]:"
    read -r WP_ADMIN_USER
    WP_ADMIN_USER=${WP_ADMIN_USER:-admin}

    echo -e "${GREEN}Admin password${NC}:"
    read -rs WP_ADMIN_PASS
    echo ""
    if [[ -z "$WP_ADMIN_PASS" ]]; then
        WP_ADMIN_PASS=$(openssl rand -base64 12)
        echo -e "${YELLOW}Generated password: ${WP_ADMIN_PASS}${NC}"
    fi

    echo -e "${GREEN}Admin email${NC} [admin@localhost.local]:"
    read -r WP_ADMIN_EMAIL
    WP_ADMIN_EMAIL=${WP_ADMIN_EMAIL:-admin@localhost.local}

    # Generate random passwords
    DB_ROOT_PASSWORD=$(openssl rand -base64 12)
    DB_PASSWORD=$(openssl rand -base64 12)

    # Create site directory
    mkdir -p "$SITE_DIR"

    # Create docker-compose.yml
    cat > "$SITE_DIR/docker-compose.yml" << EOF
services:
  wordpress:
    image: wordpress:latest
    container_name: ${SITE_NAME}-wordpress
    restart: unless-stopped
    ports:
      - "${WP_PORT}:80"
    environment:
      WORDPRESS_DB_HOST: db
      WORDPRESS_DB_USER: wordpress
      WORDPRESS_DB_PASSWORD: ${DB_PASSWORD}
      WORDPRESS_DB_NAME: wordpress
    volumes:
      - ./wp-content:/var/www/html/wp-content
      - ./uploads.ini:/usr/local/etc/php/conf.d/uploads.ini
    depends_on:
      - db

  db:
    image: mysql:8.0
    container_name: ${SITE_NAME}-db
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: wordpress
      MYSQL_USER: wordpress
      MYSQL_PASSWORD: ${DB_PASSWORD}
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
    volumes:
      - db_data:/var/lib/mysql
EOF

    # Add phpMyAdmin if requested
    if [[ "$INCLUDE_PMA" =~ ^[Yy]$ ]]; then
        cat >> "$SITE_DIR/docker-compose.yml" << EOF

  phpmyadmin:
    image: phpmyadmin:latest
    container_name: ${SITE_NAME}-phpmyadmin
    restart: unless-stopped
    ports:
      - "${PMA_PORT}:80"
    environment:
      PMA_HOST: db
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
    depends_on:
      - db
EOF
    fi

    # Add volumes section
    cat >> "$SITE_DIR/docker-compose.yml" << EOF

volumes:
  db_data:
EOF

    # Create PHP upload config
    cat > "$SITE_DIR/uploads.ini" << EOF
file_uploads = On
upload_max_filesize = 64M
post_max_size = 64M
max_execution_time = 300
EOF

    # Create wp-content directory
    mkdir -p "$SITE_DIR/wp-content"

    # Create .env file with credentials
    cat > "$SITE_DIR/.env" << EOF
# Database Credentials
DB_ROOT_PASSWORD=${DB_ROOT_PASSWORD}
DB_PASSWORD=${DB_PASSWORD}
EOF

    echo ""
    echo -e "${GREEN}Site created successfully!${NC}"
    echo ""
    echo "Location: $SITE_DIR"
    echo ""

    # Ask to start
    echo -e "${GREEN}Start the site now?${NC} [Y/n]:"
    read -r START_NOW
    START_NOW=${START_NOW:-Y}

    if [[ "$START_NOW" =~ ^[Yy]$ ]]; then
        cd "$SITE_DIR"
        docker compose up -d

        echo ""
        echo -e "${YELLOW}Waiting for database to be ready...${NC}"

        # Wait for MySQL to be ready
        until docker compose exec -T db mysqladmin ping -h localhost -u wordpress -p"${DB_PASSWORD}" --silent > /dev/null 2>&1; do
            sleep 2
        done

        echo -e "${YELLOW}Waiting for WordPress to be ready...${NC}"

        # Wait for WordPress to return a valid page (not database error)
        until curl -s "http://localhost:${WP_PORT}/wp-admin/install.php" | grep -q "language" > /dev/null 2>&1; do
            sleep 2
        done

        sleep 2

        echo -e "${YELLOW}Running WordPress installation...${NC}"

        COOKIE_FILE=$(mktemp)

        # Step 1: Select language (English)
        curl -s -c "$COOKIE_FILE" -b "$COOKIE_FILE" -L \
            -X POST "http://localhost:${WP_PORT}/wp-admin/install.php?step=1" \
            --data-urlencode "language=en_US" > /dev/null 2>&1

        sleep 1

        # Step 2: Run WordPress installation
        curl -s -c "$COOKIE_FILE" -b "$COOKIE_FILE" -L \
            -X POST "http://localhost:${WP_PORT}/wp-admin/install.php?step=2" \
            --data-urlencode "weblog_title=${WP_TITLE}" \
            --data-urlencode "user_name=${WP_ADMIN_USER}" \
            --data-urlencode "admin_password=${WP_ADMIN_PASS}" \
            --data-urlencode "admin_password2=${WP_ADMIN_PASS}" \
            --data-urlencode "admin_email=${WP_ADMIN_EMAIL}" \
            --data-urlencode "blog_public=1" \
            --data-urlencode "Submit=Install WordPress" > /dev/null 2>&1

        rm -f "$COOKIE_FILE"

        echo ""
        echo -e "${GREEN}WordPress installed successfully!${NC}"
        echo ""
        echo -e "Site:       ${BLUE}http://localhost:${WP_PORT}${NC}"
        echo -e "Admin:      ${BLUE}http://localhost:${WP_PORT}/wp-admin${NC}"
        echo -e "Username:   ${WP_ADMIN_USER}"
        echo -e "Password:   ${WP_ADMIN_PASS}"
        if [[ "$INCLUDE_PMA" =~ ^[Yy]$ ]]; then
            echo -e "phpMyAdmin: ${BLUE}http://localhost:${PMA_PORT}${NC}"
        fi
        echo ""
    fi
}

list_sites() {
    echo -e "${GREEN}Your WordPress sites:${NC}"
    echo ""

    if [[ ! -d "$SITES_DIR" ]]; then
        echo "No sites created yet."
        return
    fi

    for site in "$SITES_DIR"/*/; do
        if [[ -d "$site" ]]; then
            site_name=$(basename "$site")

            # Check if running
            if docker ps --format '{{.Names}}' | grep -q "${site_name}-wordpress"; then
                status="${GREEN}running${NC}"
            else
                status="${YELLOW}stopped${NC}"
            fi

            echo -e "  $site_name - $status"
        fi
    done
}

start_site() {
    echo -e "${GREEN}Site name to start:${NC}"
    read -r SITE_NAME

    SITE_DIR="$SITES_DIR/$SITE_NAME"

    if [[ ! -d "$SITE_DIR" ]]; then
        echo "Site not found."
        exit 1
    fi

    cd "$SITE_DIR"
    docker compose up -d
    echo -e "${GREEN}Site started!${NC}"
}

stop_site() {
    echo -e "${GREEN}Site name to stop:${NC}"
    read -r SITE_NAME

    SITE_DIR="$SITES_DIR/$SITE_NAME"

    if [[ ! -d "$SITE_DIR" ]]; then
        echo "Site not found."
        exit 1
    fi

    cd "$SITE_DIR"
    docker compose down
    echo -e "${GREEN}Site stopped!${NC}"
}

delete_site() {
    echo -e "${GREEN}Site name to delete:${NC}"
    read -r SITE_NAME

    SITE_DIR="$SITES_DIR/$SITE_NAME"

    if [[ ! -d "$SITE_DIR" ]]; then
        echo "Site not found."
        exit 1
    fi

    echo -e "${YELLOW}This will delete all site files and database. Continue? [y/N]:${NC}"
    read -r CONFIRM

    if [[ "$CONFIRM" =~ ^[Yy]$ ]]; then
        cd "$SITE_DIR"
        docker compose down -v 2>/dev/null || true
        rm -rf "$SITE_DIR"
        echo -e "${GREEN}Site deleted.${NC}"
    fi
}

show_menu() {
    echo ""
    echo "What would you like to do?"
    echo ""
    echo "  1) Create new site"
    echo "  2) List sites"
    echo "  3) Start site"
    echo "  4) Stop site"
    echo "  5) Delete site"
    echo "  6) Exit"
    echo ""
    echo -e "${GREEN}Choice${NC} [1-6]:"
}

# Main
print_header

# Handle command line arguments
case "${1:-}" in
    create)
        create_site
        ;;
    list)
        list_sites
        ;;
    start)
        start_site
        ;;
    stop)
        stop_site
        ;;
    delete)
        delete_site
        ;;
    *)
        # Interactive menu
        while true; do
            show_menu
            read -r choice

            case $choice in
                1) create_site ;;
                2) list_sites ;;
                3) start_site ;;
                4) stop_site ;;
                5) delete_site ;;
                6) echo "Goodbye!"; exit 0 ;;
                *) echo "Invalid choice" ;;
            esac
        done
        ;;
esac
